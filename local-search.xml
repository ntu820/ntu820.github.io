<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>调用ES的Rest Api</title>
    <link href="/2022/03/28/ES/"/>
    <url>/2022/03/28/ES/</url>
    
    <content type="html"><![CDATA[<h3 id="ES介绍"><a href="#ES介绍" class="headerlink" title="ES介绍"></a>ES介绍</h3><p><strong><a href="https://www.elastic.co/cn/elasticsearch/">Elasticsearch</a> 是一个分布式、高扩展、高实时的搜索与数据分析引擎。它能很方便的使大量数据具有搜索、分析和探索的能力。充分利用Elasticsearch的水平伸缩性，能使数据在生产环境变得更有价值。Elasticsearch 的实现原理主要分为以下几个步骤，首先用户将数据提交到Elasticsearch 数据库中，再通过分词控制器去将对应的语句分词，将其权重和分词结果一并存入数据，当用户搜索数据时候，再根据权重将结果排名，打分，再将返回结果呈现给用户。</strong></p><h3 id="Rest-Api使用"><a href="#Rest-Api使用" class="headerlink" title="Rest Api使用"></a>Rest Api使用</h3><ol><li><p>新建索引</p><p><strong>PUT</strong> <code>http://192.168.186.34:9200/[索引名称]?pretty</code></p><p>返回结果：</p><figure class="highlight json"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><pre><code class="hljs json">&#123;<br><span class="hljs-attr">&quot;acknowledged&quot;</span>: <span class="hljs-literal">true</span>,<br><span class="hljs-attr">&quot;shards_acknowledged&quot;</span>: <span class="hljs-literal">true</span>,<br><span class="hljs-attr">&quot;index&quot;</span>: <span class="hljs-string">&quot;esb01&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>查询所有[指定索引名称]索引</p><p><strong>GET</strong> <code>http://192.168.186.34:9200/_cat/indices/[指定查看索引名称]?v</code></p><p>返回结果：</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs tex">health status index          uuid                   pri rep docs.count docs.deleted store.size pri.store.size<br>yellow open   esb01          YGAh5h<span class="hljs-built_in">_</span>kRoCsPloXy-izxg   1   1          0            0       208b           208b<br>yellow open   esb1           oQKqdAQXShCJuMOzVdfs7A   1   1          2            0     11.6kb         11.6kb<br>yellow open   esb            -b6<span class="hljs-built_in">_</span>v24FRS2tp9y-ohdouw   1   1     156566            0     68.8mb         68.8mb<br>yellow open   esb-2022-03-28 PSwgzv8rR3iZcPOxbZuPTw   1   1         88            0    205.9kb        205.9kb<br>green  open   .kibana<span class="hljs-built_in">_</span>1      UF0<span class="hljs-built_in">_</span>tkz0QjChT-ToRowqUQ   1   0       1479           40    336.4kb        336.4kb<br>yellow open   t1             uXd6GoLyQpK82YkagbO<span class="hljs-built_in">_</span>ag   1   1          2            0     11.7kb         11.7kb<br>yellow open   t2             tvbutoedSNWYxmy6TTFhTw   1   1          2            0     11.7kb         11.7kb<br>yellow open   esb-2022-03-26 i8e4g<span class="hljs-built_in">_</span>0fTzqFtn-OYN27pA   1   1       4762            0      2.6mb          2.6mb<br>yellow open   esb-2022-03-27 wrm87nSJT-K-pRFG0oofXg   1   1        576            0    705.6kb        705.6kb<br>yellow open   t3             -nBkF1RzRxWUOlYVExZhTw   1   1          1            0      5.9kb          5.9kb<br><br></code></pre></td></tr></table></figure></li><li><p>查询索引默认索引配置</p><p><strong>GET</strong> <code>http://192.168.186.34:9200/[索引名称]/_mapping?pretty</code></p><p>返回结果：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br><span class="hljs-attr">&quot;esb-2022-03-27&quot;</span>: &#123;<br><span class="hljs-attr">&quot;mappings&quot;</span>: &#123;<br><span class="hljs-attr">&quot;properties&quot;</span>: &#123;<br><span class="hljs-attr">&quot;data&quot;</span>: &#123;<br><span class="hljs-attr">&quot;properties&quot;</span>: &#123;<br><span class="hljs-attr">&quot;ACCTDATE&quot;</span>: &#123;<br><span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br><span class="hljs-attr">&quot;fields&quot;</span>: &#123;<br><span class="hljs-attr">&quot;keyword&quot;</span>: &#123;<br><span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;keyword&quot;</span>,<br><span class="hljs-attr">&quot;ignore_above&quot;</span>: <span class="hljs-number">256</span><br>&#125;<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-string">&quot;requestId&quot;</span>: &#123;<br><span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br><span class="hljs-attr">&quot;fields&quot;</span>: &#123;<br><span class="hljs-attr">&quot;keyword&quot;</span>: &#123;<br><span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;keyword&quot;</span>,<br><span class="hljs-attr">&quot;ignore_above&quot;</span>: <span class="hljs-number">256</span><br>&#125;<br>&#125;<br>&#125;,<br><span class="hljs-attr">&quot;serviceCode&quot;</span>: &#123;<br><span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br><span class="hljs-attr">&quot;fields&quot;</span>: &#123;<br><span class="hljs-attr">&quot;keyword&quot;</span>: &#123;<br><span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;keyword&quot;</span>,<br><span class="hljs-attr">&quot;ignore_above&quot;</span>: <span class="hljs-number">256</span><br>&#125;<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>新增数据</p><p><strong>POST</strong> <code>http://192.168.186.34:9200/[索引名称]/[type，一般为json/doc]?pretty</code></p><p>请求Body：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br><span class="hljs-attr">&quot;transTime&quot;</span>: <span class="hljs-number">1648373786067</span>,<br><span class="hljs-attr">&quot;data&quot;</span>: &#123;<br><span class="hljs-attr">&quot;pass&quot;</span>: <span class="hljs-string">&quot;1111111111&quot;</span>,<br><span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;11111111&quot;</span><br>&#125;,<br><span class="hljs-attr">&quot;serviceCode&quot;</span>: <span class="hljs-string">&quot;1090109102&quot;</span>,<br><span class="hljs-attr">&quot;requestId&quot;</span>: <span class="hljs-string">&quot;aeb9adf2-618f-4c6b-a965-5bea4698e893&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>返回结果：（以json为例）</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br><span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;esb-2022-03-27&quot;</span>,<br><span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;json&quot;</span>,<br><span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;h_XCyn8Bthbf_40jLeF_&quot;</span>,<br><span class="hljs-attr">&quot;_version&quot;</span>: <span class="hljs-number">1</span>,<br><span class="hljs-attr">&quot;result&quot;</span>: <span class="hljs-string">&quot;created&quot;</span>,<br><span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br><span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">2</span>,<br><span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">1</span>,<br><span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>&#125;,<br><span class="hljs-attr">&quot;_seq_no&quot;</span>: <span class="hljs-number">535</span>,<br><span class="hljs-attr">&quot;_primary_term&quot;</span>: <span class="hljs-number">1</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>查询数据</p><p><strong>GET</strong> <code>http://192.168.186.34:9200/[索引名称，支持通配符，可实现多个索引一起查询]/_search?pretty=true</code></p><p>请求Body：</p><ul><li>查询所有数据</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>    <span class="hljs-attr">&quot;query&quot;</span>:&#123;<br>        <span class="hljs-attr">&quot;match_all&quot;</span>:&#123;<br><br>        &#125;<br>    &#125;,<br>    <span class="hljs-attr">&quot;from&quot;</span>:<span class="hljs-number">0</span>,<br>    <span class="hljs-attr">&quot;size&quot;</span>:<span class="hljs-number">20</span>,<br>    <span class="hljs-attr">&quot;sort&quot;</span>:[<br>        &#123;<br>            <span class="hljs-attr">&quot;_seq_no&quot;</span>:&#123;<br>                <span class="hljs-attr">&quot;order&quot;</span>:<span class="hljs-string">&quot;desc&quot;</span><br>            &#125;<br>        &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>根据某个字段查询（精确）</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br><span class="hljs-attr">&quot;query&quot;</span>: &#123;<br><span class="hljs-attr">&quot;bool&quot;</span>: &#123;<br><span class="hljs-attr">&quot;must&quot;</span>: [&#123;<br>    <span class="hljs-attr">&quot;match_phrase[match]&quot;</span>:&#123;<br>        <span class="hljs-attr">&quot;[serviceCode，查询的某个字段]&quot;</span>:<span class="hljs-string">&quot;test001&quot;</span><br>    &#125;<br>&#125;]<br>&#125;<br>&#125;,<br><span class="hljs-attr">&quot;sort&quot;</span>: [<br>&#123;<br><span class="hljs-attr">&quot;_seq_no&quot;</span>: &#123;<br><span class="hljs-attr">&quot;order&quot;</span>: <span class="hljs-string">&quot;desc&quot;</span><br>&#125;<br>&#125;<br>],<br><span class="hljs-attr">&quot;from&quot;</span>: <span class="hljs-number">0</span>,<br><span class="hljs-attr">&quot;size&quot;</span>: <span class="hljs-number">20</span><br>&#125;<br></code></pre></td></tr></table></figure><ul><li>查询某个字段是否存在</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br><span class="hljs-attr">&quot;query&quot;</span>: &#123;<br><span class="hljs-attr">&quot;bool&quot;</span>: &#123;<br><span class="hljs-attr">&quot;must&quot;</span>: [&#123;<br>    <span class="hljs-attr">&quot;exists&quot;</span>:&#123;<br>        <span class="hljs-attr">&quot;field&quot;</span>:<span class="hljs-string">&quot;[字段名称]&quot;</span><br>    &#125;<br>&#125;]<br>&#125;<br>&#125;,<br><span class="hljs-attr">&quot;sort&quot;</span>: [<br>&#123;<br><span class="hljs-attr">&quot;_seq_no&quot;</span>: &#123;<br><span class="hljs-attr">&quot;order&quot;</span>: <span class="hljs-string">&quot;desc&quot;</span><br>&#125;<br>&#125;<br>],<br><span class="hljs-attr">&quot;from&quot;</span>: <span class="hljs-number">0</span>,<br><span class="hljs-attr">&quot;size&quot;</span>: <span class="hljs-number">20</span><br>&#125;<br></code></pre></td></tr></table></figure><ul><li>检索某个值</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br><span class="hljs-attr">&quot;query&quot;</span>: &#123;<br><span class="hljs-attr">&quot;simple_query_string&quot;</span>: &#123;<br><span class="hljs-attr">&quot;query&quot;</span>: <span class="hljs-string">&quot;[具体值]&quot;</span>,<br><span class="hljs-attr">&quot;default_operator&quot;</span>: <span class="hljs-string">&quot;and&quot;</span><br>&#125;<br>&#125;,<br><span class="hljs-attr">&quot;from&quot;</span>: <span class="hljs-number">0</span>,<br><span class="hljs-attr">&quot;size&quot;</span>: <span class="hljs-number">20</span>,<br><span class="hljs-attr">&quot;sort&quot;</span>: [<br>&#123;<br><span class="hljs-attr">&quot;_seq_no&quot;</span>: &#123;<br><span class="hljs-attr">&quot;order&quot;</span>: <span class="hljs-string">&quot;desc&quot;</span><br>&#125;<br>&#125;<br>]<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>多条件查询</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br><span class="hljs-attr">&quot;query&quot;</span>: &#123;<br><span class="hljs-attr">&quot;bool&quot;</span>: &#123;<br><span class="hljs-attr">&quot;must&quot;</span>: [<br>&#123;<br><span class="hljs-attr">&quot;match_phrase&quot;</span>: &#123;<br><span class="hljs-attr">&quot;serviceCode&quot;</span>: <span class="hljs-string">&quot;1090109102&quot;</span><br>&#125;<br>&#125;,<br>&#123;<br><span class="hljs-attr">&quot;exists&quot;</span>: &#123;<br><span class="hljs-attr">&quot;field&quot;</span>: <span class="hljs-string">&quot;data.name&quot;</span><br>&#125;<br>&#125;<br>]<br>&#125;<br>&#125;,<br><span class="hljs-attr">&quot;from&quot;</span>: <span class="hljs-number">0</span>,<br><span class="hljs-attr">&quot;size&quot;</span>: <span class="hljs-number">20</span>,<br><span class="hljs-attr">&quot;sort&quot;</span>: [<br>&#123;<br><span class="hljs-attr">&quot;_seq_no&quot;</span>: &#123;<br><span class="hljs-attr">&quot;order&quot;</span>: <span class="hljs-string">&quot;desc&quot;</span><br>&#125;<br>&#125;<br>]<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>范围查询</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;range&quot;</span>: &#123;<br>      <span class="hljs-attr">&quot;[transTime,范围字段]&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;gte&quot;</span>: <span class="hljs-number">1648426657334</span>,<br>        <span class="hljs-attr">&quot;lte&quot;</span>: <span class="hljs-number">1648430679534</span><br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol>]]></content>
    
    
    <categories>
      
      <category>Elasticsearch</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Elasticsearch</tag>
      
      <tag>Http</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Nginx常用配置</title>
    <link href="/2022/03/25/ngcfg/"/>
    <url>/2022/03/25/ngcfg/</url>
    
    <content type="html"><![CDATA[<h3 id="location匹配规则"><a href="#location匹配规则" class="headerlink" title="location匹配规则"></a>location匹配规则</h3><ol><li>= 表示精确匹配。只有请求的url路径与后面的字符串完全相等时，才会命中。</li><li>^~ 表示如果该符号后面的字符是最佳匹配，采用该规则，不再进行后续的查找。</li><li>~ 表示该规则是使用正则定义的，区分大小写。</li><li>~* 表示该规则是使用正则定义的，不区分大小写。<br>注意：nginx按照上面的顺序进行优先匹配，一旦匹配直接退出。</li></ol><p>剩下的匹配，会按照<strong>最长匹配长度优先级来匹配</strong>，就是谁匹配的多就用谁。</p><figure class="highlight nginx"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">server_name</span> website.com;<br>    <span class="hljs-attribute">location</span> /document &#123;<br>        <span class="hljs-attribute">return</span> <span class="hljs-number">701</span>;<br>    &#125;<br>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~* ^/docume.*$</span> &#123;<br>        <span class="hljs-attribute">return</span> <span class="hljs-number">702</span>;<br>    &#125;<br>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~* ^/document$</span> &#123;<br>        <span class="hljs-attribute">return</span> <span class="hljs-number">703</span>;<br>    &#125;<br><br>&#125;<br><span class="hljs-attribute">curl</span> -I  website.com:<span class="hljs-number">8080</span>/document <span class="hljs-number">702</span><br><span class="hljs-comment"># 匹配702 因为正则的优先级更高,而且正则是一旦匹配到就直接退出 所以不会再匹配703</span><br></code></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">server_name</span> website.com;<br>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~* ^/docume.*$</span> &#123;<br>        <span class="hljs-attribute">return</span> <span class="hljs-number">701</span>;<br>    &#125;<br><br>    <span class="hljs-attribute">location</span><span class="hljs-regexp"> ^~</span> /doc &#123;<br>        <span class="hljs-attribute">return</span> <span class="hljs-number">702</span>;<br>    &#125;<br>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~* ^/document$</span> &#123;<br>        <span class="hljs-attribute">return</span> <span class="hljs-number">703</span>;<br>    &#125;<br>&#125;<br><span class="hljs-attribute">curl</span> http://website.com/document<br>HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span> <span class="hljs-number">702</span><br><span class="hljs-comment"># 匹配702 因为 ^~精确匹配的优先级比正则高 也是匹配到之后支持退出</span><br></code></pre></td></tr></table></figure><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">server &#123;<br>    server_name website.com;<br>    <span class="hljs-keyword">location</span> <span class="hljs-title">/doc</span> &#123;<br>        return <span class="hljs-number">702</span>;<br>    &#125;<br>    <span class="hljs-keyword">location</span> <span class="hljs-title">/docu</span> &#123;<br>        return <span class="hljs-number">701</span>;<br>    &#125;<br>&#125;<br><span class="hljs-comment"># 701 前缀匹配匹配是按照最长匹配，跟顺序无关</span><br></code></pre></td></tr></table></figure><h3 id="history模式、跨域、缓存、反向代理"><a href="#history模式、跨域、缓存、反向代理" class="headerlink" title="history模式、跨域、缓存、反向代理"></a>history模式、跨域、缓存、反向代理</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># html设置history模式</span><br><span class="hljs-attribute">location</span> / &#123;<br>    <span class="hljs-attribute">index</span> index.html index.htm;<br>    <span class="hljs-attribute">proxy_set_header</span> Host $host;<br>    <span class="hljs-comment"># history模式最重要就是这里</span><br>    <span class="hljs-attribute">try_files</span> $uri $uri/ /index.html;<br>    <span class="hljs-comment"># index.html文件不可以设置强缓存 设置协商缓存即可</span><br>    <span class="hljs-attribute">add_header</span> Cache-Control <span class="hljs-string">&#x27;no-cache, must-revalidate, proxy-revalidate, max-age=0&#x27;</span>;<br>&#125;<br><br><span class="hljs-comment"># 接口反向代理</span><br><span class="hljs-attribute">location</span><span class="hljs-regexp"> ^~</span> /api/ &#123;<br>    <span class="hljs-comment"># 跨域处理 设置头部域名</span><br>    <span class="hljs-attribute">add_header</span> Access-Control-Allow-Origin *;<br>    <span class="hljs-comment"># 跨域处理 设置头部方法</span><br>    <span class="hljs-attribute">add_header</span> Access-Control-Allow-Methods <span class="hljs-string">&#x27;GET,POST,DELETE,OPTIONS,HEAD&#x27;</span>;<br>    <span class="hljs-comment"># 改写路径</span><br>    <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^/api/(.*)$</span> /<span class="hljs-variable">$1</span> <span class="hljs-literal">break</span>;<br>    <span class="hljs-comment"># 反向代理</span><br>    <span class="hljs-attribute">proxy_pass</span> http://static_env;<br>    <span class="hljs-attribute">proxy_set_header</span> Host $http_host;<br>&#125;<br><br><span class="hljs-attribute">location</span> <span class="hljs-regexp">~* \.(?:css(\.map)?|js(\.map)?|gif|svg|jfif|ico|cur|heic|webp|tiff?|mp3|m4a|aac|ogg|midi?|wav|mp4|mov|webm|mpe?g|avi|ogv|flv|wmv)$</span> &#123;<br>    <span class="hljs-comment"># 静态资源设置七天强缓存</span><br>    <span class="hljs-attribute">expires</span> <span class="hljs-number">7d</span>;<br>    <span class="hljs-attribute">access_log</span> <span class="hljs-literal">off</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="以目录区分多个history单文件"><a href="#以目录区分多个history单文件" class="headerlink" title="以目录区分多个history单文件"></a>以目录区分多个history单文件</h3><p>因为不可能每一个项目开启一个域名，仅仅指向通过增加路径来划分多个网站，比如：</p><ol><li><strong>ntu820.top/abc/login</strong> 访问abc登录页</li><li><strong>ntu820.top/def/login</strong> 访问def登录页<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs awk">server &#123;<br>    listen <span class="hljs-number">80</span>;<br>    server_name ntu820.top;<br>    index index.html index.htm;<br>    <span class="hljs-comment"># 通过正则来匹配捕获 [abc|def]中间的这个路径</span><br>    location ~ ^<span class="hljs-regexp">/([^\/]+)/</span>(.*)$ &#123;<br>        try_files <span class="hljs-variable">$uri</span> <span class="hljs-variable">$uri</span><span class="hljs-regexp">/ /</span><span class="hljs-variable">$1</span><span class="hljs-regexp">/dist/i</span>ndex.html =<span class="hljs-number">404</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h3 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h3><p>基于upstream做负载均衡,中间会涉及一些相关的策略比如<strong>ip_hash、weight</strong></p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs scss">upstream backserver&#123; <br>    # 哈希算法，自动定位到该服务器 保证唯一ip定位到同一部机器 用于解决session登录态的问题<br>    ip_hash; <br>    server 127<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>:<span class="hljs-number">9090</span> down; (down 表示单前的server暂时不参与负载) <br>    server 127<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>:<span class="hljs-number">8080</span> weight=<span class="hljs-number">2</span>; (weight 默认为<span class="hljs-number">1</span>.weight越大，负载的权重就越大) <br>    server 127<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>:<span class="hljs-number">6060</span>; <br>    server 127<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>:<span class="hljs-number">7070</span> backup; (其它所有的非backup机器down或者忙的时候，请求backup机器) <br>&#125; <br></code></pre></td></tr></table></figure><h3 id="灰度部署"><a href="#灰度部署" class="headerlink" title="灰度部署"></a>灰度部署</h3><p>获取头部值，在nginx中可以通过$http_xxx来获取变量，然后根据header值来进行回复发布</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">upstream</span> stable &#123;<br>    <span class="hljs-attribute">server</span> xxx max_fails=<span class="hljs-number">1</span> fail_timeout=<span class="hljs-number">60</span>;<br>    <span class="hljs-attribute">server</span> xxx max_fails=<span class="hljs-number">1</span> fail_timeout=<span class="hljs-number">60</span>;<br> &#125;<br><span class="hljs-attribute">upstream</span> canara &#123;<br>   <span class="hljs-attribute">server</span> xxx max_fails=<span class="hljs-number">1</span> fail_timeout=<span class="hljs-number">60</span>;<br>&#125;<br><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span>  xxx;<br>    <span class="hljs-comment"># 设置默认</span><br>    <span class="hljs-attribute">set</span> $group <span class="hljs-string">&quot;stable&quot;</span>;<br><br>    <span class="hljs-comment"># 根据cookie头部设置接入的服务</span><br>    <span class="hljs-attribute">if</span> ($http_cookie <span class="hljs-regexp">~* &quot;tts_version_id=canara&quot;)</span>&#123;<br>        <span class="hljs-attribute">set</span> $group canara;<br>    &#125;<br>    <span class="hljs-attribute">if</span> ($http_cookie <span class="hljs-regexp">~* &quot;tts_version_id=stable&quot;)</span>&#123;<br>        <span class="hljs-attribute">set</span> $group stable;<br>    &#125;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">proxy_pass</span> http://$group;<br>        <span class="hljs-attribute">proxy_set_header</span>   Host             $host;<br>        <span class="hljs-attribute">proxy_set_header</span>   X-Real-IP        $remote_addr;<br>        <span class="hljs-attribute">proxy_set_header</span>   X-Forwarded-For $proxy_add_x_forwarded_for;<br>        <span class="hljs-attribute">index</span>  index.html index.htm;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="优雅降级"><a href="#优雅降级" class="headerlink" title="优雅降级"></a>优雅降级</h3><p>常用于ssr的node服务挂了返回500错误码然后降级到csr的cos桶或者nginx中，优雅降级主要用<strong>error_page</strong>参数来进行降级指向备用地址。</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">upstream</span> ssr &#123;<br>    <span class="hljs-attribute">server</span> xxx max_fails=<span class="hljs-number">1</span> fail_timeout=<span class="hljs-number">60</span>;<br>    <span class="hljs-attribute">server</span> xxx max_fails=<span class="hljs-number">1</span> fail_timeout=<span class="hljs-number">60</span>;<br> &#125;<br><span class="hljs-attribute">upstream</span> csr &#123;<br>    <span class="hljs-attribute">server</span> xxx max_fails=<span class="hljs-number">1</span> fail_timeout=<span class="hljs-number">60</span>;<br>    <span class="hljs-attribute">server</span> xxx max_fails=<span class="hljs-number">1</span> fail_timeout=<span class="hljs-number">60</span>;<br>&#125;<br><br><span class="hljs-attribute">location</span><span class="hljs-regexp"> ^~</span> /ssr/ &#123;<br>    <span class="hljs-attribute">proxy_pass</span> http://ssr;<br>    <span class="hljs-comment"># 开启自定义错误捕获 如果这里不设置为on的话 会走向nginx处理的默认错误页面</span><br>    <span class="hljs-attribute">proxy_intercept_errors</span> <span class="hljs-literal">on</span>;<br>    <span class="hljs-comment"># 捕获500系列错误 如果500错误的话降级为下面的csr渲染</span><br>    <span class="hljs-attribute">error_page</span> <span class="hljs-number">500</span> <span class="hljs-number">501</span> <span class="hljs-number">502</span> <span class="hljs-number">503</span> <span class="hljs-number">504</span> = @csr_location<br><br>    <span class="hljs-comment"># error_page 500 501 502 503 504 = 200 @csr_location</span><br>    <span class="hljs-comment"># 注意这上面的区别 等号前面没有200 表示 最终返回的状态码已 @csr_location为准 加了200的话表示不管@csr_location返回啥都返回200状态码</span><br>&#125;<br><br>location @csr_location &#123;<br>    <span class="hljs-comment"># 这时候地址还是带着/ssr/的要去除</span><br>    <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^/ssr/(.*)$</span> /<span class="hljs-variable">$1</span> <span class="hljs-literal">break</span>;<br>    <span class="hljs-attribute">proxy_pass</span> http://csr;<br>    <span class="hljs-attribute">rewrite_log</span> <span class="hljs-literal">on</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="webp根据浏览器自动降级为png"><a href="#webp根据浏览器自动降级为png" class="headerlink" title="webp根据浏览器自动降级为png"></a>webp根据浏览器自动降级为png</h3><p>这套方案不像常见的由nginx把png转为webp的方案，而是先经由图床系统（node服务）上传两份图片:</p><ol><li>一份是原图png</li><li>一份是png压缩为webp的图片（使用的是imagemin-webp)</li></ol><p>然后通过nginx检测头部是否支持webp来返回webp图片，不支持的话就返回原图即可。这其中还做了错误拦截，如果cos桶丢失webp图片及时浏览器支持webp也要降级为png。</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><code class="hljs awk">http &#123;<br>  include       <span class="hljs-regexp">/etc/</span>nginx/mime.types;<br>  default_type  application/octet-stream;<br><br>  <span class="hljs-comment"># 设置日志格式</span><br>  log_format  main  <span class="hljs-string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br>  <span class="hljs-string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br>  <span class="hljs-string">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span><br>  <span class="hljs-string">&#x27;&quot;$proxy_host&quot; &quot;$upstream_addr&quot;&#x27;</span>;<br><br>  access_log  <span class="hljs-regexp">/var/</span>log<span class="hljs-regexp">/nginx/</span>access.log  main;<br><br>  sendfile        on;<br>  keepalive_timeout  <span class="hljs-number">65</span>;<br><br>  <span class="hljs-comment"># 开启gzip</span><br>  gzip on;<br>  gzip_vary on;<br>  gzip_proxied any;<br>  gzip_comp_level <span class="hljs-number">6</span>;<br>  gzip_types text<span class="hljs-regexp">/plain text/</span>css text<span class="hljs-regexp">/xml application/</span>json application<span class="hljs-regexp">/javascript application/</span>rss+xml application<span class="hljs-regexp">/atom+xml image/</span>svg+xml;<br><br>  <span class="hljs-comment"># 负载均衡 这里可以是多个cos桶地址即可</span><br>  upstream static_env &#123;<br>    server xxx;<br>    server xxx;<br>  &#125;<br><br>  <span class="hljs-comment"># map 设置变量映射 第一个变量指的是要通过映射的key值 Accpet 第二个值的是变量别名</span><br>  map <span class="hljs-variable">$http_accept</span> <span class="hljs-variable">$webp_suffix</span> &#123;<br>    <span class="hljs-comment"># 默认为 空字符串</span><br>    default   <span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-comment"># 正则匹配如果Accep含有webp字段 设置为.webp值</span><br>    <span class="hljs-string">&quot;~*webp&quot;</span>  <span class="hljs-string">&quot;.webp&quot;</span>;<br>  &#125;<br>  server &#123;<br><br>    listen <span class="hljs-number">8888</span>;<br>    absolute_redirect off;    <span class="hljs-comment">#取消绝对路径的重定向</span><br>    <span class="hljs-comment">#网站主页路径。此路径仅供参考，具体请您按照实际目录操作。</span><br>    root <span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/nginx/</span>html;<br><br>    location / &#123;<br>      index index.html index.htm;<br>      proxy_set_header Host <span class="hljs-variable">$host</span>;<br>      try_files <span class="hljs-variable">$uri</span> <span class="hljs-variable">$uri</span><span class="hljs-regexp">/ /i</span>ndex.html;<br>      add_header Cache-Control <span class="hljs-string">&#x27;no-cache, max-age=0&#x27;</span>;<br>    &#125;<br><br>    <span class="hljs-comment"># favicon.ico</span><br>    location = /favicon.ico &#123;<br>      log_not_found off;<br>      access_log off;<br>    &#125;<br><br>    <span class="hljs-comment"># robots.txt</span><br>    location = /robots.txt &#123;<br>      log_not_found off;<br>      access_log off;<br>    &#125;<br><br>    <span class="hljs-comment"># </span><br>    location ~* \.(png|jpe?g)$ &#123;<br>      <span class="hljs-comment"># Pass WebP support header to backend</span><br>      <span class="hljs-comment"># 如果header头部中支持webp</span><br>      <span class="hljs-keyword">if</span> (<span class="hljs-variable">$webp_suffix</span> ~* webp) &#123;<br>        <span class="hljs-comment"># 先尝试找是否有webp格式图片</span><br>        rewrite ^<span class="hljs-regexp">/(.*)\.(png|jpe?g)$ /</span><span class="hljs-variable">$1</span>.webp <span class="hljs-keyword">break</span>;<br>        <span class="hljs-comment"># 找不到的话 这里捕获404错误 返回原始错误 注意这里的=号 代表最终返回的是@static_img的状态吗</span><br>        error_page <span class="hljs-number">404</span> = @static_img;<br>      &#125;<br>      proxy_intercept_errors on;<br>      add_header Vary Accept;<br>      proxy_pass http:<span class="hljs-regexp">//</span>static_env;<br>      proxy_set_header Host <span class="hljs-variable">$http_host</span>;<br>      expires <span class="hljs-number">7</span>d;<br>      access_log off;<br>    &#125;<br><br>    location @static_img &#123;<br>      <span class="hljs-comment">#set $complete $schema $server_addr $request_uri;</span><br>      rewrite ^/.+$ <span class="hljs-variable">$request_uri</span> <span class="hljs-keyword">break</span>;<br>      proxy_pass http:<span class="hljs-regexp">//</span>static_env;<br>      proxy_set_header Host <span class="hljs-variable">$http_host</span>;<br>      expires <span class="hljs-number">7</span>d;<br>    &#125;<br><br><br>    <span class="hljs-comment"># assets, media</span><br>    location ~* \.(?:css(\.map)?|js(\.map)?|gif|svg|jfif|ico|cur|heic|webp|tiff?|mp3|m4a|aac|ogg|midi?|wav|mp4|mov|webm|mpe?g|avi|ogv|flv|wmv)$ &#123;<br>      proxy_pass http:<span class="hljs-regexp">//</span>static_env;<br>      proxy_set_header Host <span class="hljs-variable">$http_host</span>;<br>      expires <span class="hljs-number">7</span>d;<br>      access_log off;<br>    &#125;<br><br><br>    error_page   <span class="hljs-number">500</span> <span class="hljs-number">502</span> <span class="hljs-number">503</span> <span class="hljs-number">504</span>  /<span class="hljs-number">50</span>x.html;<br>    location = /<span class="hljs-number">50</span>x.html &#123;<br>      root   <span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/nginx/</span>html;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>nginx</category>
      
      <category>运维</category>
      
    </categories>
    
    
    <tags>
      
      <tag>nginx</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>haproxy+keepalived实现高可用</title>
    <link href="/2022/01/30/keepha/"/>
    <url>/2022/01/30/keepha/</url>
    
    <content type="html"><![CDATA[<p><strong><a href="https://www.keepalived.org/">Keepalived</a> 提供 VRPP 实现，并允许您配置 Linux 机器使负载均衡，预防单点故障。<a href="http://www.haproxy.org/">HAProxy</a> 提供可靠、高性能的负载均衡，能与 Keepalived 完美配合。</strong></p><p><img src="/img/keepha/%E6%9E%B6%E6%9E%84.jpg" alt="架构图"></p><p>安装规定组件</p><figure class="highlight sh"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs sh">yum install keepalived haproxy psmisc -y<br></code></pre></td></tr></table></figure><h3 id="HAproxy"><a href="#HAproxy" class="headerlink" title="HAproxy"></a>HAproxy</h3><ol><li><p>编辑haproxy配置，（两台机器proxy配置一致）</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">vi /etc/haproxy/haproxy.conf<br></code></pre></td></tr></table></figure></li><li><p>参考配置</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs sh">global<br>    <span class="hljs-built_in">log</span>         /dev/<span class="hljs-built_in">log</span> local0 warning<br>    chroot      /var/lib/haproxy<br>    pidfile     /var/run/haproxy.pid<br>    maxconn     4000<br>    user        haproxy<br>    group       haproxy<br>    daemon<br><br>    stats socket /var/lib/haproxy/stats<br><br>defaults<br>    <span class="hljs-built_in">log</span>                     global<br>    option                  httplog<br>    option                  dontlognull<br>    timeout connect         5000<br>    timeout client          50000<br>    timeout server          50000<br><br>frontend kube-apiserver<br>    <span class="hljs-built_in">bind</span>                        *:6443<br>    mode                        tcp<br>    option                      tcplog<br>    default_backend             kube-apiserver<br><br>backend kube-apiserver<br>    mode        tcp<br>    option      tcplog<br>    option      tcp-check<br>    balance     roundrobin<br>    default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100<br>    server  kube-apiserver-1 172.16.214.21:6443 check<br>    server  kube-apiserver-2 172.16.214.22:6443 check<br>    server  kube-apiserver-3 172.16.214.23:6443 check<br></code></pre></td></tr></table></figure></li></ol><h3 id="Keepalived"><a href="#Keepalived" class="headerlink" title="Keepalived"></a>Keepalived</h3><ol><li><p>两台机器都安装keepalived，但是配置略有不同</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">vi /etc/keepalived/keepalived.conf<br></code></pre></td></tr></table></figure></li><li><p>参考配置</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 主服务配置</span><br>global_defs &#123;<br>   notification_email &#123;<br>   &#125;<br>   router_id LVS_DEVEL01<br>   vrrp_skip_check_adv_addr<br>   vrrp_garp_interval 0<br>   vrrp_gna_interval 0<br>&#125;<br><br>vrrp_script chk_haproxy &#123;<br>   script <span class="hljs-string">&quot;killall -0 haproxy&quot;</span><br>   interval 2<br>   weight 2<br>&#125;<br><br>vrrp_instance haproxy-vip &#123;<br>    state MASTER<br>    interface eth0<br>    virtual_router_id 60<br>    priority 100<br>    advert_int 1<br>    authentication &#123;<br>        auth_type PASS<br>        auth_pass 1111<br>    &#125;<br>    unicast_src_ip 172.16.214.31<br>    unicast_peer &#123;<br>        172.16.214.32<br>    &#125;<br><br>    virtual_ipaddress &#123;<br>        172.16.214.30/24<br>    &#125;<br><br>    track_script &#123;<br>        chk_haproxy<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># 从服务配置</span><br>global_defs &#123;<br>   notification_email &#123;<br>   &#125;<br>   router_id LVS_DEVEL02<br>   vrrp_skip_check_adv_addr<br>   vrrp_garp_interval 0<br>   vrrp_gna_interval 0<br>&#125;<br><br>vrrp_script chk_haproxy &#123;<br>   script <span class="hljs-string">&quot;killall -0 haproxy&quot;</span><br>   interval 2<br>   weight 2<br>&#125;<br><br>vrrp_instance haproxy-vip &#123;<br>    state BACKUP<br>    interface eth0<br>    virtual_router_id 60<br>    priority 90<br>    advert_int 1<br>    authentication &#123;<br>        auth_type PASS<br>        auth_pass 1111<br>    &#125;<br>    unicast_src_ip 172.16.214.32<br>    unicast_peer &#123;<br>        172.16.214.31<br>    &#125;<br><br>    virtual_ipaddress &#123;<br>        172.16.214.30/24<br>    &#125;<br><br>    track_script &#123;<br>        chk_haproxy<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><ol><li><p>开启并开机启动</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">systemctl restart haproxy &amp;&amp; systemctl <span class="hljs-built_in">enable</span> haproxy<br>systemctl restart keepalived &amp;&amp; systemctl <span class="hljs-built_in">enable</span> keepalived<br></code></pre></td></tr></table></figure></li></ol><h3 id="验证高可用"><a href="#验证高可用" class="headerlink" title="验证高可用"></a>验证高可用</h3><ol><li>停止keepalived，查看vip是否会漂移。</li></ol>]]></content>
    
    
    <categories>
      
      <category>keepalived</category>
      
      <category>haproxy</category>
      
    </categories>
    
    
    <tags>
      
      <tag>keepalived</tag>
      
      <tag>haproxy</tag>
      
      <tag>软负载</tag>
      
      <tag>高可用</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>私有化部署yapi</title>
    <link href="/2022/01/30/yapi/"/>
    <url>/2022/01/30/yapi/</url>
    
    <content type="html"><![CDATA[<h4 id="安装nodejs环境"><a href="#安装nodejs环境" class="headerlink" title="安装nodejs环境"></a>安装nodejs环境</h4><figure class="highlight sh"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 下载</span><br>wget https://nodejs.org/dist/v10.16.0/node-v10.16.0-linux-x64.tar.xz<br><br><span class="hljs-comment"># 解压</span><br>tar -xvf node-v10.16.0-linux-x64.tar.xz<br><br><span class="hljs-comment">#创建软连接</span><br>ln -s ~/node-v10.16.0-linux-x64/bin/node /usr/<span class="hljs-built_in">local</span>/bin/node<br>ln -s ~/node-v10.16.0-linux-x64/bin/npm /usr/<span class="hljs-built_in">local</span>/bin/npm<br><br><span class="hljs-comment"># 验证</span><br>node -v<br>npm -v<br><br><span class="hljs-comment"># 配置淘宝源</span><br>npm config <span class="hljs-built_in">set</span> registry https://registry.npm.taobao.org<br></code></pre></td></tr></table></figure><h4 id="安装mongodb"><a href="#安装mongodb" class="headerlink" title="安装mongodb"></a>安装mongodb</h4><p>在/etc/yum.repos.d/下，新建mongodb-org.repo，内容如下</p><p>[mongodb-org]<br>name=MongoDB Repository<br>baseurl=<a href="http://mirrors.aliyun.com/mongodb/yum/redhat/7Server/mongodb-org/3.2/x86_64/">http://mirrors.aliyun.com/mongodb/yum/redhat/7Server/mongodb-org/3.2/x86_64/</a><br>gpgcheck=0<br>enabled=1</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 安装</span><br>yum install -y mongodb-org<br><br><span class="hljs-comment"># 启动</span><br>service mongod start<br><br><span class="hljs-comment"># 配置，如果mongo只应用本地，则无需修改，否则修改/etc/mongod.conf的bindIp，并重启</span><br></code></pre></td></tr></table></figure><h4 id="安装yapi"><a href="#安装yapi" class="headerlink" title="安装yapi"></a>安装yapi</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs sh">mkdir yapi<br><br><span class="hljs-built_in">cd</span> yapi<br><br>git <span class="hljs-built_in">clone</span> https://github.com/YMFE/yapi.git vendor<br><br><span class="hljs-comment"># 或者下载 zip 包解压到 vendors 目录（clone 整个仓库大概 140+ M，可以通过 `git clone --depth=1 https://github.com/YMFE/yapi.git vendors` 命令减少，大概 10+ M）</span><br><br><br>cp vendors/config_example.json ./config.json <br><span class="hljs-comment"># 复制完成后请修改相关配置</span><br><span class="hljs-comment"># 需要把mongodb的用户名密码去除</span><br><br><span class="hljs-built_in">cd</span> vendors<br><br>npm install --production --registry https://registry.npm.taobao.org<br><br>npm run install-server <br><span class="hljs-comment"># 安装程序会初始化数据库索引和管理员账号，管理员账号名可在 config.json 配置</span><br><br>node server/app.js <br><span class="hljs-comment"># 启动服务器后，请访问 127.0.0.1:&#123;config.json配置的端口&#125;，初次运行会有个编译的过程，请耐心等候</span><br><br><span class="hljs-comment"># 初始化管理员账号成功,账号名：&quot;admin@admin.com&quot;，密码：&quot;ymfe.org&quot;</span><br></code></pre></td></tr></table></figure><h4 id="后台运行yapi"><a href="#后台运行yapi" class="headerlink" title="后台运行yapi"></a>后台运行yapi</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">npm install -g pm2<br><br>ln -s ~/node-v10.16.0-linux-x64/lib/node_modules/pm2/bin/pm2 /usr/<span class="hljs-built_in">local</span>/bin/pm2<br><br>pm2 start server/app.js<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>yapi</category>
      
    </categories>
    
    
    <tags>
      
      <tag>node</tag>
      
      <tag>yapi</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>在windows上部署docker实战</title>
    <link href="/2022/01/30/windocker/"/>
    <url>/2022/01/30/windocker/</url>
    
    <content type="html"><![CDATA[<p>目前在windows上部署docker方式有两种。第一：采用虚拟机进行部署；第二：采用Hyper-V虚拟技术进行部署。微软自windows server2016开始将docker集成进系统。目前支持docker in windows部署方式的系统有：win10、windwos server2016/2019。本文采用Hyper-V方式进行docker部署。</p><h4 id="主板开启虚拟化，系统安装Hyper-V的windows更新。"><a href="#主板开启虚拟化，系统安装Hyper-V的windows更新。" class="headerlink" title="主板开启虚拟化，系统安装Hyper-V的windows更新。"></a>主板开启虚拟化，系统安装Hyper-V的windows更新。</h4><p>打开windows更新。将Hyper-V全部选中。</p><p><img src="/img/windocker/%E5%9B%BE%E7%89%871.png" alt="hyper"></p><h4 id="安装docker-desktop"><a href="#安装docker-desktop" class="headerlink" title="安装docker desktop"></a>安装docker desktop</h4><p>下载地址：<a href="https://download.docker.com/win/stable/Docker%20Desktop%20Installer.exe">https://download.docker.com/win/stable/Docker%20Desktop%20Installer.exe</a><br><img src="/img/windocker/%E5%9B%BE%E7%89%872.png" alt="dockerdesktop"></p><p>出现此图标，代表docker安装成功。</p><h4 id="切换windows镜像模式"><a href="#切换windows镜像模式" class="headerlink" title="切换windows镜像模式"></a>切换windows镜像模式</h4><p>由于我们需要安装运行基于windows的容器与镜像，所有在安装完后，右击图标，将docker的运行方式改位“windows containers”。</p><p><img src="/img/windocker/%E5%9B%BE%E7%89%873.png" alt="windocker"></p><h4 id="简单配置"><a href="#简单配置" class="headerlink" title="简单配置"></a>简单配置</h4><p>对docker进行一些配置，以达到更好的效果。【如果能科学上网，请忽略此步】</p><p><img src="/img/windocker/%E5%9B%BE%E7%89%874.png" alt="配置"></p><h4 id="拉取windowsserver的镜像"><a href="#拉取windowsserver的镜像" class="headerlink" title="拉取windowsserver的镜像"></a>拉取windowsserver的镜像</h4><figure class="highlight sh"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><pre><code class="hljs sh">docker pull mcr.microsoft.com/windows/servercore:ltsc2019<br>docker pull mcr.microsoft.com/windows/nanoserver:1903<br></code></pre></td></tr></table></figure><p>注意：windows的docker容器拉取镜像时，镜像的tag必须要osversion的版本必须与镜像版本对应。<br>查看系统版本信息：systeminfo</p><p><img src="/img/windocker/%E5%9B%BE%E7%89%875.png" alt="系统版本"></p><p><img src="/img/windocker/%E5%9B%BE%E7%89%876.png" alt="找到对应镜像"></p><p>拉取的镜像比较大需要耐心等待。</p><p><img src="/img/windocker/%E5%9B%BE%E7%89%877.png" alt="拉取镜像"></p><h4 id="运行windows原生镜像"><a href="#运行windows原生镜像" class="headerlink" title="运行windows原生镜像"></a>运行windows原生镜像</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">docker run -it mcr.microsoft.com/windows/nanoserver:1903 cmd.exe<br></code></pre></td></tr></table></figure><p>运行后会进入容器内部。盘符会进入C盘位置。退出后，使用docker ps会发现容器也退出了，此时，输入docker start 容器ID。重新启动容器，发现容器正常启动。</p><h4 id="测试镜像"><a href="#测试镜像" class="headerlink" title="测试镜像"></a>测试镜像</h4><p>在windwos容器中部署python环境</p><ul><li>首先停止windows容器，docker stop 容器ID</li><li>使用docker cp命令，将本地宿主机上的文件拷贝进windows容器中。由于容器中不包含GUI，所以这里直接将python的免安装文件复制进容器。<code>docker cp D:\develop\python37 容器ID:\C:\Users</code></li><li>docker start 容器ID</li><li>docker exec -it 容器ID cmd.exe 进入容器内部</li><li>进入C盘下面的Users文件夹。发现python文件夹已经拷贝进来。<img src="/img/windocker/%E5%9B%BE%E7%89%878.png" alt="python"></li><li>验证python环境，进入pyhon37文件夹，运行python命令，发现可以进入。<img src="/img/windocker/%E5%9B%BE%E7%89%879.png" alt="python"></li></ul>]]></content>
    
    
    <categories>
      
      <category>docker</category>
      
    </categories>
    
    
    <tags>
      
      <tag>docker</tag>
      
      <tag>windows</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>seata高可用部署</title>
    <link href="/2022/01/30/seata%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/"/>
    <url>/2022/01/30/seata%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<h4 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h4><ul><li>部署nacos</li><li>部署mysql</li></ul><h4 id="部署server端"><a href="#部署server端" class="headerlink" title="部署server端"></a>部署server端</h4><ul><li><p>创建数据库（seata）及表,以mysql为例</p><figure class="highlight sql"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></div></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- -------------------------------- The script used when storeMode is &#x27;db&#x27; --------------------------------</span><br><span class="hljs-comment">-- the table to store GlobalSession data</span><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> `global_table`<br>(<br>    `xid`                       <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">128</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    `transaction_id`            <span class="hljs-type">BIGINT</span>,<br>    `status`                    TINYINT      <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    `application_id`            <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">32</span>),<br>    `transaction_service_group` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">32</span>),<br>    `transaction_name`          <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">128</span>),<br>    `timeout`                   <span class="hljs-type">INT</span>,<br>    `begin_time`                <span class="hljs-type">BIGINT</span>,<br>    `application_data`          <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">2000</span>),<br>    `gmt_create`                DATETIME,<br>    `gmt_modified`              DATETIME,<br>    <span class="hljs-keyword">PRIMARY</span> KEY (`xid`),<br>    KEY `idx_gmt_modified_status` (`gmt_modified`, `status`),<br>    KEY `idx_transaction_id` (`transaction_id`)<br>) ENGINE <span class="hljs-operator">=</span> InnoDB<br>  <span class="hljs-keyword">DEFAULT</span> CHARSET <span class="hljs-operator">=</span> utf8;<br><br><span class="hljs-comment">-- the table to store BranchSession data</span><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> `branch_table`<br>(<br>    `branch_id`         <span class="hljs-type">BIGINT</span>       <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    `xid`               <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">128</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    `transaction_id`    <span class="hljs-type">BIGINT</span>,<br>    `resource_group_id` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">32</span>),<br>    `resource_id`       <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">256</span>),<br>    `branch_type`       <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">8</span>),<br>    `status`            TINYINT,<br>    `client_id`         <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>),<br>    `application_data`  <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">2000</span>),<br>    `gmt_create`        DATETIME(<span class="hljs-number">6</span>),<br>    `gmt_modified`      DATETIME(<span class="hljs-number">6</span>),<br>    <span class="hljs-keyword">PRIMARY</span> KEY (`branch_id`),<br>    KEY `idx_xid` (`xid`)<br>) ENGINE <span class="hljs-operator">=</span> InnoDB<br>  <span class="hljs-keyword">DEFAULT</span> CHARSET <span class="hljs-operator">=</span> utf8;<br><br><span class="hljs-comment">-- the table to store lock data</span><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> `lock_table`<br>(<br>    `row_key`        <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">128</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    `xid`            <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">128</span>),<br>    `transaction_id` <span class="hljs-type">BIGINT</span>,<br>    `branch_id`      <span class="hljs-type">BIGINT</span>       <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    `resource_id`    <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">256</span>),<br>    `table_name`     <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">32</span>),<br>    `pk`             <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">36</span>),<br>    `gmt_create`     DATETIME,<br>    `gmt_modified`   DATETIME,<br>    <span class="hljs-keyword">PRIMARY</span> KEY (`row_key`),<br>    KEY `idx_branch_id` (`branch_id`)<br>) ENGINE <span class="hljs-operator">=</span> InnoDB<br>  <span class="hljs-keyword">DEFAULT</span> CHARSET <span class="hljs-operator">=</span> utf8;<br></code></pre></td></tr></table></figure></li><li><p>client端，业务数据库需要添加undo_log表，以mysql为例</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- for AT mode you must to init this sql for you business database. the seata server not need it.</span><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> `undo_log`<br>(<br>    `branch_id`     <span class="hljs-type">BIGINT</span>       <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;branch transaction id&#x27;</span>,<br>    `xid`           <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">128</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;global transaction id&#x27;</span>,<br>    `context`       <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">128</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;undo_log context,such as serialization&#x27;</span>,<br>    `rollback_info` LONGBLOB     <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;rollback info&#x27;</span>,<br>    `log_status`    <span class="hljs-type">INT</span>(<span class="hljs-number">11</span>)      <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;0normal status,1defense status&#x27;</span>,<br>    `log_created`   DATETIME(<span class="hljs-number">6</span>)  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;create datetime&#x27;</span>,<br>    `log_modified`  DATETIME(<span class="hljs-number">6</span>)  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;modify datetime&#x27;</span>,<br>    <span class="hljs-keyword">UNIQUE</span> KEY `ux_undo_log` (`xid`, `branch_id`)<br>) ENGINE <span class="hljs-operator">=</span> InnoDB<br>  AUTO_INCREMENT <span class="hljs-operator">=</span> <span class="hljs-number">1</span><br>  <span class="hljs-keyword">DEFAULT</span> CHARSET <span class="hljs-operator">=</span> utf8 COMMENT <span class="hljs-operator">=</span><span class="hljs-string">&#x27;AT transaction mode undo table&#x27;</span>;<br></code></pre></td></tr></table></figure></li><li><p>添加配置到nacos配置中心，使用官方的的脚本将默认的配置文件导入nacos</p></li><li><p>修改配置，主要是数据库的连接配置</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs text">store.mode=db<br>store.db.datasource=druid<br>store.db.dbType=mysql<br>store.db.driverClassName=com.mysql.jdbc.Driver<br>store.db.url=jdbc:mysql://192.168.199.2:30060/seata?useUnicode=true<br>store.db.user=root<br>store.db.password=123456<br></code></pre></td></tr></table></figure></li></ul><h4 id="部署到K8S"><a href="#部署到K8S" class="headerlink" title="部署到K8S"></a>部署到K8S</h4><ul><li><p>seata-ha-deploy.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">seata-ha-server</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app.kubernetes.io/name:</span> <span class="hljs-string">seata-ha-server</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">NodePort</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">8091</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">http</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app.kubernetes.io/name:</span> <span class="hljs-string">seata-ha-server</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">StatefulSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">seata-ha-server</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app.kubernetes.io/name:</span> <span class="hljs-string">seata-ha-server</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">serviceName:</span> <span class="hljs-string">seata-ha-server</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app.kubernetes.io/name:</span> <span class="hljs-string">seata-ha-server</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app.kubernetes.io/name:</span> <span class="hljs-string">seata-ha-server</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">imagePullSecrets:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">default-harbor-secret</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">seata-ha-server</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.182</span><span class="hljs-number">.187</span><span class="hljs-string">:81/library/seata-server:1.4.2</span><br>          <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>          <span class="hljs-attr">env:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">SEATA_CONFIG_NAME</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">file:/root/seata-config/registry</span><br>          <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8091</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>          <span class="hljs-attr">volumeMounts:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">seata-config</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/root/seata-config</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">seata-config</span><br>          <span class="hljs-attr">configMap:</span><br>            <span class="hljs-attr">name:</span> <span class="hljs-string">seata-ha-server-config</span><br><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">seata-ha-server-config</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-attr">registry.conf:</span> <span class="hljs-string">|</span><br><span class="hljs-string">    registry &#123;</span><br><span class="hljs-string">        type = &quot;nacos&quot;</span><br><span class="hljs-string">        nacos &#123;</span><br><span class="hljs-string">          application = &quot;seata-server&quot;</span><br><span class="hljs-string">          serverAddr = &quot;192.168.186.79:8849&quot;</span><br><span class="hljs-string">          group = &quot;SEATA_GROUP&quot;</span><br><span class="hljs-string">          namespace = &quot;87eb1383-a697-439a-a40f-52a071b4cc6b&quot;</span><br><span class="hljs-string">          cluster = &quot;default&quot;</span><br><span class="hljs-string">          username = &quot;nacos&quot;</span><br><span class="hljs-string">          password = &quot;nacos&quot;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">    config &#123;</span><br><span class="hljs-string">      type = &quot;nacos&quot;</span><br><span class="hljs-string">      nacos &#123;</span><br><span class="hljs-string">        serverAddr = &quot;192.168.186.79:8849&quot;</span><br><span class="hljs-string">        namespace = &quot;87eb1383-a697-439a-a40f-52a071b4cc6b&quot;</span><br><span class="hljs-string">        group = &quot;SEATA_GROUP&quot;</span><br><span class="hljs-string">        username = &quot;nacos&quot;</span><br><span class="hljs-string">        password = &quot;nacos&quot;</span><br><span class="hljs-string">      &#125;</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string"></span><br></code></pre></td></tr></table></figure></li><li><p>查看部署情况</p><p>1、应该会有3个pod运行，查看日志，可以看到已经连接数据。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">11</span>:<span class="hljs-number">22</span>:<span class="hljs-number">25.586</span>  INFO --- [                     main] io.seata.server.Server                   : The server is running in container.<br><span class="hljs-number">11</span>:<span class="hljs-number">22</span>:<span class="hljs-number">25.599</span>  INFO --- [                     main] io.seata.config.FileConfiguration        : The file name of the operation is file:/root/seata-config/registry<br><span class="hljs-number">11</span>:<span class="hljs-number">22</span>:<span class="hljs-number">25.606</span>  INFO --- [                     main] io.seata.config.FileConfiguration        : The configuration file used is /root/seata-config/registry.conf<br><span class="hljs-number">11</span>:<span class="hljs-number">22</span>:<span class="hljs-number">27.127</span>  INFO --- [                     main] com.alibaba.druid.pool.DruidDataSource   : &#123;dataSource-<span class="hljs-number">1</span>&#125; inited<br><span class="hljs-number">11</span>:<span class="hljs-number">22</span>:<span class="hljs-number">27.367</span>  INFO --- [                     main] i.s.core.rpc.netty.NettyServerBootstrap  : Server started, listen port: <span class="hljs-number">8091</span><br></code></pre></td></tr></table></figure><p>2、去nacos中查看，应该会有3个服务。</p><p><img src="/img/seata%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/20210720193847.png" alt="seata"></p></li></ul>]]></content>
    
    
    <categories>
      
      <category>seata</category>
      
    </categories>
    
    
    <tags>
      
      <tag>seata</tag>
      
      <tag>分布式事务</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>nacos集群安装</title>
    <link href="/2022/01/30/nacos%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85/"/>
    <url>/2022/01/30/nacos%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85/</url>
    
    <content type="html"><![CDATA[<h3 id="1-在线安装mysql5-7"><a href="#1-在线安装mysql5-7" class="headerlink" title="1. 在线安装mysql5.7"></a>1. 在线安装mysql5.7</h3><ul><li>安装步骤</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 获取mysql yum源</span><br>yum install -y wget &amp;&amp; wget https://dev.mysql.com/get/mysql57-community-release-el7-9.noarch.rpm<br><span class="hljs-comment"># 安装yum源</span><br>rpm -ivh mysql57-community-release-el7-9.noarch.rpm<br><span class="hljs-comment"># 安装mysql</span><br>yum install mysql-community-server mysql-community-libs-compat mysql-community-libs mysql-community-embedded-devel mysql-community-embedded-compat mysql-community-embedded mysql-community-devel mysql-community-common mysql-community-client -y<br></code></pre></td></tr></table></figure><ul><li>启动</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 启动mysql</span><br>systemctl start mysqld<br><span class="hljs-comment"># 开机启动</span><br>systemctl <span class="hljs-built_in">enable</span> mysqld<br><span class="hljs-comment"># 需要找到mysql初始化的密码，cat /var/log/mysqld.log|grep root</span><br></code></pre></td></tr></table></figure><ul><li>运行<code>mysql_secure_installation</code>进行一些初始化操作，主要是对更改密码、是否运行远程等</li></ul><h3 id="rpm包安装mysql5-7"><a href="#rpm包安装mysql5-7" class="headerlink" title="rpm包安装mysql5.7"></a>rpm包安装mysql5.7</h3><ul><li>下载rpm包</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-community-common-5.7.23-1.el7.x86_64.rpm<br>https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-community-libs-5.7.23-1.el7.x86_64.rpm<br>https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-community-client-5.7.23-1.el7.x86_64.rpm<br>https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-community-server-5.7.23-1.el7.x86_64.rpm<br>https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-community-devel-5.7.23-1.el7.x86_64.rpm<br></code></pre></td></tr></table></figure><ul><li>安装mysql</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 下载自带的mariadb</span><br>yum remove mariadb mariadb-server mariadb-devel mariadb-libs<br><span class="hljs-comment"># 安装</span><br>rpm -ivh mysql-community-common-5.7.23-1.el7.x86_64.rpm <br>rpm -ivh mysql-community-libs-5.7.23-1.el7.x86_64.rpm <br>rpm -ivh mysql-community-client-5.7.23-1.el7.x86_64.rpm <br>rpm -ivh mysql-community-server-5.7.23-1.el7.x86_64.rpm <br>rpm -ivh mysql-community-devel-5.7.23-1.el7.x86_64.rpm<br></code></pre></td></tr></table></figure><ul><li>新建主库文件夹</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">mkdir -p /data/mysql/&#123;data,<span class="hljs-built_in">log</span>,pid,binary&#125;<br>groupadd mysql<br>useradd -r -g mysql mysql<br>chown -R mysql.mysql  /data<br></code></pre></td></tr></table></figure><ul><li>配置主数据库，<code>vi /etc/my.cnf</code></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs sh">[mysqld]<br>datadir=/data/mysql/data<br>socket=/data/mysql/data/mysql.sock<br> <br>log-error=/data/mysql/<span class="hljs-built_in">log</span>/mysqld.log<br>pid-file=/data/mysql/pid/mysqld.pid<br> <br>user=mysql<br>server-id=1<br>port=3306<br> <br><span class="hljs-comment">##要给从机同步的库</span><br><span class="hljs-comment">#binlog-do-db=</span><br> <br><span class="hljs-comment">##不给从机同步的库(多个写多行)</span><br>binlog-ignore-db=mysql<br>binlog-ignore-db=information_schema<br>binlog-ignore-db=performance_schema<br>binlog-ignore-db=sys<br> <br><span class="hljs-comment">##开启二进制日志</span><br>log-bin=/data/mysql/binary/mysql1-bin<br> <br><span class="hljs-comment">##自动清理 7 天前的log文件,可根据需要修改</span><br>expire_logs_days=7<br> <br>[client]<br>socket=/data/mysql/data/mysql.sock<br></code></pre></td></tr></table></figure><ul><li>新建从库文件夹</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">mkdir -p /data/mysql/&#123;data,<span class="hljs-built_in">log</span>,pid&#125;<br>groupadd mysql<br>useradd -r -g mysql mysql<br>chown -R mysql.mysql  /data<br></code></pre></td></tr></table></figure><ul><li>配置从数据库</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs sh">[mysqld]<br>datadir=/data/mysql/data<br>socket=/data/mysql/data/mysql.sock<br> <br><span class="hljs-comment"># Disabling symbolic-links is recommended to prevent assorted security risks</span><br>symbolic-links=0<br> <br>log-error=/data/mysql/<span class="hljs-built_in">log</span>/mysqld.log<br>pid-file=/data/mysql/pid/mysqld.pid<br> <br>user=mysql<br>server-id=2<br>port=3306<br> <br><span class="hljs-comment">##从库上的参数</span><br>read_only = 1<br>master_info_repository=TABLE<br>relay_log_info_repository=TABLE<br><span class="hljs-comment">#relay_log_recovery=1   #从机禁止写</span><br><span class="hljs-comment">#super_read_only=1      #从机禁止写</span><br> <br>[client]<br>socket=/data/mysql/data/mysql.sock<br></code></pre></td></tr></table></figure><ul><li>启动数据库并找出root密码</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">systemctl start mysqld<br><br><span class="hljs-comment"># 查询密码</span><br>cat /data/mysql/<span class="hljs-built_in">log</span>/mysqld.log |grep root<br></code></pre></td></tr></table></figure><ul><li>登录并修改密码</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysql -uroot -p<br><br><span class="hljs-comment"># 修改密码</span><br>mysql-&gt; ALTER USER root@localhost identified by <span class="hljs-string">&#x27;admin123.X&#x27;</span>;<br></code></pre></td></tr></table></figure><h3 id="配置主从"><a href="#配置主从" class="headerlink" title="配置主从"></a>配置主从</h3><ul><li>在主服务器上授权从服务器复制帐号</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysql -uroot -p<br>mysql-&gt; grant replication slave on *.* to slave@<span class="hljs-string">&#x27;192.168.%&#x27;</span> identified by <span class="hljs-string">&#x27;admin123.X&#x27;</span>;<br>mysql-&gt; show master status;<br></code></pre></td></tr></table></figure><ul><li>到从服务配置主数据库连接</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysql -uroot -p<br><br>mysql &gt; stop slave;<br>mysql &gt; change master to master_host=<span class="hljs-string">&#x27;192.168.153.162&#x27;</span>,master_port=3306,master_user=<span class="hljs-string">&#x27;slave&#x27;</span>,master_password=<span class="hljs-string">&#x27;admin123.X&#x27;</span>,master_log_file=<span class="hljs-string">&#x27;mysql1-bin.000093&#x27;</span>,master_log_pos=846;<br>mysql &gt; start slave;<br>mysql &gt; show slave status\G<br><span class="hljs-comment"># 必须看到两个YES</span><br><span class="hljs-comment"># Slave_IO_Running: Yes</span><br><span class="hljs-comment"># Slave_SQL_Running: Yes</span><br></code></pre></td></tr></table></figure><h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysql &gt; CREATE DATABASE test_ab default charset utf8;<br>mysql &gt; CREATE TABLE test_ab.a1(id int(2),name varchar(20));<br>mysql &gt; INSERT INTO test_ab.a1(id,name) VALUES(1,<span class="hljs-string">&quot;测试1&quot;</span>);<br>mysql&gt; select * from test_ab.a1;<br></code></pre></td></tr></table></figure><h3 id="2-安装Nacos1-3"><a href="#2-安装Nacos1-3" class="headerlink" title="2. 安装Nacos1.3"></a>2. 安装Nacos1.3</h3><ul><li>配置JDK、Maven</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 解压缩</span><br>tar -zxvf jdk-8u261-linux-x64.tar.gz<br>mv jdk1.8.0_261 /usr/<span class="hljs-built_in">local</span>/bin/<br>tar -zxvf apache-maven-3.6.3-bin.tar.gz<br>mv apache-maven-3.6.3 /usr/<span class="hljs-built_in">local</span>/bin/<br><br><span class="hljs-comment"># 配置环境变量</span><br>vi /etc/profile<br><br><span class="hljs-comment"># 在最后添加</span><br><span class="hljs-built_in">export</span> MAVEN_HOME=/usr/<span class="hljs-built_in">local</span>/bin/apache-maven-3.6.3<br><span class="hljs-built_in">export</span> JAVA_HOME=/usr/<span class="hljs-built_in">local</span>/bin/jdk1.8.0_261<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$PATH</span>:<span class="hljs-variable">$MAVEN_HOME</span>/bin<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$PATH</span>:<span class="hljs-variable">$JAVA_HOME</span>/bin<br><br><span class="hljs-comment"># 配置生效</span><br><span class="hljs-built_in">source</span> /etc/profile<br><br><span class="hljs-comment"># 验证生效</span><br>java -version<br>mvn -v<br></code></pre></td></tr></table></figure><ul><li>为nacos创建数据库连接用户</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">create user nacos identified by <span class="hljs-string">&#x27;nacos123.X&#x27;</span>;<br><br>grant all privileges on *.* to <span class="hljs-string">&#x27;nacos&#x27;</span>@<span class="hljs-string">&#x27;192.168.%&#x27;</span> identified by <span class="hljs-string">&#x27;nacos123.X&#x27;</span> with grant option;<br><br>flush privileges;<br></code></pre></td></tr></table></figure><ul><li>解压nacos，并移动到安装目录</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">tar -zxvf nacos-server-1.3.0.tar.gz<br>mv nacos /usr/<span class="hljs-built_in">local</span>/<br></code></pre></td></tr></table></figure><ul><li>初始化数据库脚本，找到 <code>nacos-mysql.sql</code> ，将其导入到数据库中</li><li>配置文件，<code>vi application.properties</code></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">spring.datasource.platform=mysql<br>db.num=1<br>db.url.0=jdbc:mysql://192.168.153.161:3306/nacos_config?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=<span class="hljs-literal">true</span><br>db.user=nacos<br>db.password=nacos123.X<br></code></pre></td></tr></table></figure><ul><li>把<code>cluster.conf.example 改名成 cluster.conf</code> ，并修改配置<code>vi cluster.conf</code></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#it is ip</span><br>10.0.0.1:8848<br>10.0.0.2:8848<br>10.0.0.3:8848<br></code></pre></td></tr></table></figure><ul><li>分别部署到服务器</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sh startup.sh<br></code></pre></td></tr></table></figure><ul><li>验证，访问不同主机的地址，查看是否可以正常访问</li></ul><h3 id="3-配置nginx反向代理"><a href="#3-配置nginx反向代理" class="headerlink" title="3. 配置nginx反向代理"></a>3. 配置nginx反向代理</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 下载nginx安装包</span><br>wget https://nginx.org/download/nginx-1.18.0.tar.gz<br><span class="hljs-comment"># 安装依赖</span><br>yum -y install gcc zlib zlib-devel pcre-devel openssl openssl-devel<br><span class="hljs-comment"># 解压</span><br>mkdir -p /usr/<span class="hljs-built_in">local</span>/nginx<br>tar -zxvf nginx-1.18.0.tar.gz<br>mv nginx-1.18.0 /usr/<span class="hljs-built_in">local</span>/nginx/<br><span class="hljs-comment"># 执行configure</span><br><span class="hljs-built_in">cd</span> /usr/<span class="hljs-built_in">local</span>/nginx/nginx-1.18.0<br>./configure<br>make<br>make install<br></code></pre></td></tr></table></figure><ul><li>配置nginx反向代理</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sh">upstream nacos &#123;<br>        server  192.168.153.161:8848;<br>        server  192.168.153.162:8848;<br>        server  192.168.153.163:8848;<br>    &#125;<br><br>server &#123;<br>        listen       80;<br>        server_name  192.168.153.163;<br><br>        location /nacos/ &#123;<br>            proxy_pass http://nacos/nacos/;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><ul><li>启动nginx</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh">/usr/<span class="hljs-built_in">local</span>/nginx/sbin/nginx -s reload<br><br><span class="hljs-comment"># 如果出现报错：nginx: [error] open() ＂/usr/local/nginx/logs/nginx.pid＂ failed</span><br>运行： `/usr/<span class="hljs-built_in">local</span>/nginx/sbin/nginx -c /usr/<span class="hljs-built_in">local</span>/nginx/conf/nginx.conf` 再次启动即可<br><br>ps -ef | grep nginx<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>nacos</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mysql</tag>
      
      <tag>nacos</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>docker启动各种服务</title>
    <link href="/2022/01/30/docker%E5%90%AF%E5%8A%A8%E5%90%84%E7%A7%8D%E6%9C%8D%E5%8A%A1/"/>
    <url>/2022/01/30/docker%E5%90%AF%E5%8A%A8%E5%90%84%E7%A7%8D%E6%9C%8D%E5%8A%A1/</url>
    
    <content type="html"><![CDATA[<h3 id="启动activemq"><a href="#启动activemq" class="headerlink" title="启动activemq"></a>启动activemq</h3><figure class="highlight sh"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><pre><code class="hljs sh">docker run --name=<span class="hljs-string">&#x27;activemq&#x27;</span> -d \<br>-e <span class="hljs-string">&#x27;ACTIVEMQ_CONFIG_NAME=amqp-srv1&#x27;</span> \<br>-e <span class="hljs-string">&#x27;ACTIVEMQ_CONFIG_DEFAULTACCOUNT=false&#x27;</span> \<br>-e <span class="hljs-string">&#x27;ACTIVEMQ_ADMIN_LOGIN=admin&#x27;</span> -e <span class="hljs-string">&#x27;ACTIVEMQ_ADMIN_PASSWORD=your_password&#x27;</span> \<br>-e <span class="hljs-string">&#x27;ACTIVEMQ_USERS_myproducer=producerpassword&#x27;</span> -e <span class="hljs-string">&#x27;ACTIVEMQ_GROUPS_writes=myproducer&#x27;</span> \<br>-e <span class="hljs-string">&#x27;ACTIVEMQ_USERS_myconsumer=consumerpassword&#x27;</span> -e <span class="hljs-string">&#x27;ACTIVEMQ_GROUPS_reads=myconsumer&#x27;</span> \<br>-e <span class="hljs-string">&#x27;ACTIVEMQ_JMX_user1_role=readwrite&#x27;</span> -e <span class="hljs-string">&#x27;ACTIVEMQ_JMX_user1_password=jmx_password&#x27;</span> \<br>-e <span class="hljs-string">&#x27;ACTIVEMQ_JMX_user2_role=read&#x27;</span> -e <span class="hljs-string">&#x27;ACTIVEMQ_JMX_user2_password=jmx2_password&#x27;</span><br>-e <span class="hljs-string">&#x27;ACTIVEMQ_CONFIG_TOPICS_topic1=mytopic1&#x27;</span> -e <span class="hljs-string">&#x27;ACTIVEMQ_CONFIG_TOPICS_topic2=mytopic2&#x27;</span>  \<br>-e <span class="hljs-string">&#x27;ACTIVEMQ_CONFIG_QUEUES_queue1=myqueue1&#x27;</span> -e <span class="hljs-string">&#x27;ACTIVEMQ_CONFIG_QUEUES_queue2=myqueue2&#x27;</span>  \<br>-e <span class="hljs-string">&#x27;ACTIVEMQ_CONFIG_MINMEMORY=1024&#x27;</span> -e  <span class="hljs-string">&#x27;ACTIVEMQ_CONFIG_MAXMEMORY=4096&#x27;</span> \<br>-e <span class="hljs-string">&#x27;ACTIVEMQ_CONFIG_SCHEDULERENABLED=true&#x27;</span> \<br>-v /data/activemq:/data \<br>-v /var/<span class="hljs-built_in">log</span>/activemq:/var/<span class="hljs-built_in">log</span>/activemq \<br>-p 8161:8161 \<br>-p 61616:61616 \<br>-p 61613:61613 \<br>webcenter/activemq:5.14.3<br></code></pre></td></tr></table></figure><p><code>docker run --name activemq-5.14 -d -e ACTIVEMQ_ADMIN_LOGIN=admin -e ACTIVEMQ_ADMIN_PASSWORD=admin@mq -v /home/activemq/data:/data -v /home/activemq/log:/var/log/activemq -p 8161:8161 -p 61616:61616 -p 61613:61613 webcenter/activemq:5.14.3</code></p><hr><h3 id="启动mysql"><a href="#启动mysql" class="headerlink" title="启动mysql"></a>启动mysql</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 简单启动</span><br>docker run -p 3306:3306 --name mysql -v <span class="hljs-variable">$PWD</span>/conf:/etc/mysql/conf.d -v <span class="hljs-variable">$PWD</span>/logs:/logs -v <span class="hljs-variable">$PWD</span>/data:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=123456 -d mysql:5.7.23<br></code></pre></td></tr></table></figure><p>-p 3306:3306：将容器的 3306 端口映射到主机的 3306 端口。<br>-v $PWD/conf:/etc/mysql/conf.d：将主机当前目录下的 conf/my.cnf 挂载到容器的 /etc/mysql/my.cnf。<br>-v $PWD/logs:/logs：将主机当前目录下的 logs 目录挂载到容器的 /logs。<br>-v $PWD/data:/var/lib/mysql :将主机当前目录下的data目录挂载到容器的 /var/lib/mysql 。<br>-e MYSQL_ROOT_PASSWORD=123456：初始化 root 用户的密码。<br>-d 后台运行</p><hr><h3 id="启动nginx"><a href="#启动nginx" class="headerlink" title="启动nginx"></a>启动nginx</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">docker run --name nginx-1.16.1 -v /home/nginxdata/x-springboot-ui:/usr/share/nginx/html -v /home/nginxdata/conf/nginx.conf:/etc/nginx/nginx.conf -v /home/nginxdata/conf.d:/etc/nginx/conf.d -v /home/nginxdata/logs:/var/<span class="hljs-built_in">log</span>/nginx -p 80:80 -d nginx:1.16.1<br></code></pre></td></tr></table></figure><p>1、配置nginx.conf，设置user为root用户<br>2、配置default.conf，开启目录浏览<br>        autoindex on; # 开启目录显示<br>        autoindex_exact_size off; # 显示出文件的确切大小.关闭详细文件大小统计，让文件大小显示MB，GB单位，默认为b<br>        autoindex_localtime on; # 显示的文件时间为文件的服务器时间<br>        charset utf-8,gbk; # 避免中文乱码</p><hr><h3 id="启动oracle-11g"><a href="#启动oracle-11g" class="headerlink" title="启动oracle 11g"></a>启动oracle 11g</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 一开始无法使用挂载，必须先启动后再使用</span><br>1、docker run --name oracle_11g -v /home/oracle:/home/oracle -p 1521:1521 -d registry.cn-hangzhou.aliyuncs.com/helowin/oracle_11g:latest<br><br>docker run --name oracle11g -v /root/oracle_data/helowin:/home/oracle/app/oracle/oradata/helowin -p 1521:1521 -d registry.cn-hangzhou.aliyuncs.com/helowin/oracle_11g:latest<br><br>2、docker <span class="hljs-built_in">exec</span> -it oracle_11g bash<br><br>3、su root 【密码】：helowin<br><br>4、vi /etc/profile<br><br><span class="hljs-built_in">export</span> ORACLE_HOME=/home/oracle/app/oracle/product/11.2.0/dbhome_2<br><span class="hljs-built_in">export</span> ORACLE_SID=helowin<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$ORACLE_HOME</span>/bin:<span class="hljs-variable">$PATH</span><br><br><span class="hljs-built_in">source</span> /etc/profile --加载环境变量<br>ln -s <span class="hljs-variable">$ORACLE_HOME</span>/bin/sqlplus /usr/bin -- 软连接<br><br>5、su - oracle<br><br>6、sqlplus /nolog<br><br>7、conn /as sysdba<br><br>8、<br>alter user system identified by system; --修改system用户账号<br><br>alter user sys identified by system; --修改sys用户账号<br><br>create user db identified by dbzenith; --创建内部管理员账号，设备管理系统默认使用db用户<br><br>grant connect,resource,dba to db; --将dba权限授权给内部管理员账号<br><br>alter profile default <span class="hljs-built_in">limit</span> password_life_time unlimited; --修改密码规则策略为密码永不过期<br><br>alter system <span class="hljs-built_in">set</span> processes=1000 scope=spfile; --修改数据库最大连接数据<br><br>9、重启数据库<br><span class="hljs-built_in">exit</span> 退出当前操作<br>sqlplus /nolog<br>conn /as sysdba<br>shutdown immediate; --关闭数据库<br>startup; --启动数据库<br><br>10、退出，查看具体实例<br>lsnrctl status<br><br><br>11、删除用户操作<br>SELECT SID,SERIAL<span class="hljs-comment"># FROM V$SESSION WHERE USERNAME=&#x27;DEVUSER&#x27;;  -- 一定都要大写</span><br>ALTER  SYSTEM  KILL SESSION <span class="hljs-string">&#x27;137,41813&#x27;</span>;<br>drop  user sstest cascade;<br><br><br><span class="hljs-comment"># --删除oracle--</span><br>rm -rf /home/oracle/app/oracle/flash_recovery_area/helowin/control02.ctl<br></code></pre></td></tr></table></figure><hr><h3 id="启动portainer"><a href="#启动portainer" class="headerlink" title="启动portainer"></a>启动portainer</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">docker run --name portainer -p 9000:9000 -v /var/run/docker.sock:/var/run/docker.sock -d portainer/portainer:linux-amd64<br></code></pre></td></tr></table></figure><hr><h3 id="启动redis"><a href="#启动redis" class="headerlink" title="启动redis"></a>启动redis</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 简单启动</span><br>docker run --name redis-5.0.7 -p 6379:6379 -d redis:5.0.7 --requirepass <span class="hljs-string">&quot;admin123&quot;</span><br><span class="hljs-comment"># 持久化</span><br>docker run --name redis -v /home/redis/data:/data -p 6379:6379 -d redis:5.0.7 --requirepass <span class="hljs-string">&quot;admin123&quot;</span> --appendonly yes<br></code></pre></td></tr></table></figure><p>–name redis-test #运行的docker容器名<br>-p 6379:6379 #宿主本地端口:docker端口(容器里的端口)<br>-d redis #daemonize模式运行，完整-d redis:版本号，默认为最新版本</p><hr><h3 id="启动sonarqube"><a href="#启动sonarqube" class="headerlink" title="启动sonarqube"></a>启动sonarqube</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 采用volume挂载方式，本地文件挂载有权限问题</span><br>docker run -d --name sonarqube --restart always \<br>-p 9000:9000 \<br>-v sonarqube_conf:/opt/sonarqube/conf \<br>-v sonarqube_extensions:/opt/sonarqube/extensions \<br>-v sonarqube_logs:/opt/sonarqube/logs \<br>-v sonarqube_data:/opt/sonarqube/data \<br>sonarqube:7.9.2-community<br><br><br><span class="hljs-comment">#分析项目</span><br><span class="hljs-comment">#1、需要先将项目打包运行</span><br><span class="hljs-comment">#2、运行分析代码</span><br>sonar-scanner -Dsonar.host.url=http://192.168.153.150:9000 \<br>              -Dsonar.projectKey=simple-java-maven-app \<br>              -Dsonar.projectName=simple-java-maven-app \<br>              -Dsonar.projectVersion=1.0 \<br>              -Dsonar.login=admin \<br>              -Dsonar.password=admin \<br>              -Dsonar.ws.timeout=30 \<br>              -Dsonar.projectDescription=<span class="hljs-string">&quot;my first project!&quot;</span> \<br>              -Dsonar.links.homepage=http://www.baidu.com \<br>              -Dsonar.sources=src \<br>              -Dsonar.sourceEncoding=UTF-8 \<br>              -Dsonar.java.binaries=target/classes \<br>              -Dsonar.java.test.binaries=target/test-classes \<br>              -Dsonar.java.surefire.report=target/surefire-reports<br></code></pre></td></tr></table></figure><hr><h3 id="启动sqlserver2017"><a href="#启动sqlserver2017" class="headerlink" title="启动sqlserver2017"></a>启动sqlserver2017</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">docker run --name sqlserver_2017 -v /home/sqlserver:/var/opt/mssql -e <span class="hljs-string">&#x27;ACCEPT_EULA=Y&#x27;</span> -e <span class="hljs-string">&#x27;SA_PASSWORD=admin123.X&#x27;</span> -p 1433:1433 -d mcr.microsoft.com/mssql/server:2017-latest<br></code></pre></td></tr></table></figure><p>使用sqlcmd创建数据库</p><p>进入容器 docker exec -it 容器名称 bash</p><p>创建数据库<br>/opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P XXXX</p><hr><h3 id="启动rabbitmq"><a href="#启动rabbitmq" class="headerlink" title="启动rabbitmq"></a>启动rabbitmq</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs sh">docker run -p 15672:15672 \<br>-p 5672:5672 \<br>-p 25672:25672 \<br>-p 15674:15674 \<br>-p 61613:61613 \<br>-v /home/yzh/Documents/Installed/docker/docker_repo/rabbitmq/:/var/lib/rabbitmq/mnesia \<br>--name rabbitmq3 \<br>--restart=always \<br>-d rabbitmq:3.7.8-management<br><br><span class="hljs-comment"># 启动rabbitmq的mqtt和stomp协议</span><br>docker run --name rabbitmq \<br>-p 15672:15672 \<br>-p 5672:5672 \<br>-p 15674:15674 \<br>-p 61613:61613 \<br>-p 15675:15675 \<br>-p 1883:1883 \<br>-d rabbitmq:3.8.14-management<br><br><span class="hljs-comment"># 进入容器内部</span><br><span class="hljs-comment"># rabbit开启stomp</span><br>rabbitmq-plugins <span class="hljs-built_in">enable</span> rabbitmq_stomp<br>rabbitmq-plugins <span class="hljs-built_in">enable</span> rabbitmq_web_stomp<br><br><span class="hljs-comment"># rabbit开启mqtt</span><br>rabbitmq-plugins <span class="hljs-built_in">enable</span> rabbitmq_mqtt<br>rabbitmq-plugins <span class="hljs-built_in">enable</span> rabbitmq_web_mqtt<br></code></pre></td></tr></table></figure><p>15672，rabbitmq的web页面端口</p><p>5672，amqp协议端口</p><p>25672，集群使用</p><p>15674，stomp的ws端口</p><p>61613，stomp的tcp端口</p><p>1883，mqtt的tcp协议端口</p><p>15675，mqtt的ws端口</p><hr><h3 id="启动traefik"><a href="#启动traefik" class="headerlink" title="启动traefik"></a>启动traefik</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">docker run --name traefik2 -d -p 8080:8080 -p 80:80 -v <span class="hljs-variable">$PWD</span>/traefik.yml:/etc/traefik/traefik.yml -v /var/run/docker.sock:/var/run/docker.sock traefik:v2.4.8<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>docker</category>
      
    </categories>
    
    
    <tags>
      
      <tag>docker</tag>
      
      <tag>container</tag>
      
      <tag>容器</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>docker-ce安装</title>
    <link href="/2022/01/30/docker-ce%E5%AE%89%E8%A3%85/"/>
    <url>/2022/01/30/docker-ce%E5%AE%89%E8%A3%85/</url>
    
    <content type="html"><![CDATA[<h4 id="卸载原有docker及缓存"><a href="#卸载原有docker及缓存" class="headerlink" title="卸载原有docker及缓存"></a>卸载原有docker及缓存</h4><ol><li><p>卸载</p><figure class="highlight shell"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs shell">yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine<br></code></pre></td></tr></table></figure></li><li><p>清缓存<br>将docker的缓存，包括镜像、图片、网络等删除。docker默认位置：/var/lib/docker</p></li></ol><h4 id="添加必要的包"><a href="#添加必要的包" class="headerlink" title="添加必要的包"></a>添加必要的包</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install -y yum-utils device-mapper-persistent-data lvm2<br></code></pre></td></tr></table></figure><h4 id="添加稳定版本仓库地址"><a href="#添加稳定版本仓库地址" class="headerlink" title="添加稳定版本仓库地址"></a>添加稳定版本仓库地址</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo<br></code></pre></td></tr></table></figure><h4 id="安装docker-ce-最新版本"><a href="#安装docker-ce-最新版本" class="headerlink" title="安装docker-ce(最新版本)"></a>安装docker-ce(最新版本)</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install -y docker-ce docker-ce-cli containerd.io<br></code></pre></td></tr></table></figure><p><strong>安装指定版本</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 查询版本</span><br>yum list docker-ce --showduplicates | sort -r<br><span class="hljs-meta">#</span><span class="bash"> 安装</span><br>yum install docker-ce-&lt;VERSION_STRING&gt; docker-ce-cli-&lt;VERSION_STRING&gt; containerd.io<br></code></pre></td></tr></table></figure><h4 id="离线安装"><a href="#离线安装" class="headerlink" title="离线安装"></a>离线安装</h4><ol><li>下载地址：<a href="https://download.docker.com/linux/static/stable/">https://download.docker.com/linux/static/stable/</a></li><li>安装步骤<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 解压包</span><br>tar xzvf /path/to/&lt;FILE&gt;.tar.gz<br><span class="hljs-meta">#</span><span class="bash"> 移动</span><br>sudo cp docker/* /usr/bin/<br><span class="hljs-meta">#</span><span class="bash"> 启动docker</span><br>sudo dockerd &amp;<br><span class="hljs-meta">#</span><span class="bash"> 验证</span><br>sudo docker run hello-world<br></code></pre></td></tr></table></figure></li></ol><h3 id="添加镜像加速"><a href="#添加镜像加速" class="headerlink" title="添加镜像加速"></a>添加镜像加速</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">vi /etc/docker/daemon.json<br><span class="hljs-meta">#</span><span class="bash"> 配置阿里镜像加速</span><br>&quot;registry-mirrors&quot;: [&quot;https://j54517kd.mirror.aliyuncs.com&quot;]<br></code></pre></td></tr></table></figure><p><strong>自动安装docker脚本</strong></p><p><a href="/img/docker-ce%E5%AE%89%E8%A3%85/install-docker.sh" title=":include :type=code">install-docker.sh</a></p>]]></content>
    
    
    <categories>
      
      <category>docker</category>
      
    </categories>
    
    
    <tags>
      
      <tag>docker</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>redis6集群安装</title>
    <link href="/2022/01/29/redis6%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85/"/>
    <url>/2022/01/29/redis6%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85/</url>
    
    <content type="html"><![CDATA[<h2 id="redis6-集群安装"><a href="#redis6-集群安装" class="headerlink" title="redis6 集群安装"></a>redis6 集群安装</h2><h3 id="gcc升级"><a href="#gcc升级" class="headerlink" title="gcc升级"></a>gcc升级</h3><p>安装redis6最主要的一点是要用GCC5以上，而CentOS6.9的GCC版本为4.8.x, 所以安装之前必须升级GCC。</p><figure class="highlight shell"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><pre><code class="hljs shell">yum -y install gcc tcl<br>yum -y install centos-release-scl<br>yum -y install devtoolset-9-gcc devtoolset-9-gcc-c++ devtoolset-9-binutils<br></code></pre></td></tr></table></figure><p>启用gcc</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;source /opt/rh/devtoolset-9/enable&quot;</span> &gt;&gt; /etc/profile<br></code></pre></td></tr></table></figure><h3 id="下载、安装"><a href="#下载、安装" class="headerlink" title="下载、安装"></a>下载、安装</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cd</span> /opt<br>wget https://download.redis.io/releases/redis-6.2.6.tar.gz<br>tar -xvf redis-6.2.6.tar.gz<br><span class="hljs-built_in">cd</span> redis-6.2.6<br>make MALLOC=libc<br>make install PREFIX=/usr/<span class="hljs-built_in">local</span>/redis<br></code></pre></td></tr></table></figure><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">mkdir -p /usr/<span class="hljs-built_in">local</span>/redis/run<br>mkdir -p /usr/<span class="hljs-built_in">local</span>/redis/<span class="hljs-built_in">log</span><br>mkdir -p /usr/<span class="hljs-built_in">local</span>/redis/data/7000<br>mkdir -p /usr/<span class="hljs-built_in">local</span>/redis/conf<br></code></pre></td></tr></table></figure><p>设置redis配置文件</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">cp /opt/redis-6.0.9/redis.conf /usr/<span class="hljs-built_in">local</span>/redis/conf/redis_7000.conf<br>vi /usr/<span class="hljs-built_in">local</span>/redis/conf/redis_7000.conf<br></code></pre></td></tr></table></figure><p>文件配置内容</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">bind</span> 192.168.146.199   <span class="hljs-comment">#添加本机的ip</span><br>port 7000  <span class="hljs-comment">#端口　　</span><br>pidfile /usr/<span class="hljs-built_in">local</span>/redis/run/redis_7000.pid   <span class="hljs-comment">#pid存储目录</span><br>logfile /usr/<span class="hljs-built_in">local</span>/redis/<span class="hljs-built_in">log</span>/redis_7000.log   <span class="hljs-comment">#日志存储目录</span><br>dir /usr/<span class="hljs-built_in">local</span>/redis/data/7000                <span class="hljs-comment">#数据存储目录，目录要提前创建好</span><br>cluster-enabled yes  <span class="hljs-comment">#开启集群</span><br>cluster-config-file nodes-7000.conf   <span class="hljs-comment">#集群节点配置文件，这个文件是不能手动编辑的。确保每一个集群节点的配置文件不通</span><br>cluster-node-timeout 15000   <span class="hljs-comment">#集群节点的超时时间，单位：ms，超时后集群会认为该节点失败</span><br>appendonly yes  <span class="hljs-comment">#持久化</span><br>daemonize yes   <span class="hljs-comment">#守护进程</span><br></code></pre></td></tr></table></figure><h3 id="建立不通的端口实例"><a href="#建立不通的端口实例" class="headerlink" title="建立不通的端口实例"></a>建立不通的端口实例</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">cp /usr/<span class="hljs-built_in">local</span>/redis/conf/redis_7000.conf /usr/<span class="hljs-built_in">local</span>/redis/conf/redis_7001.conf<br>mkdir -p /usr/<span class="hljs-built_in">local</span>/redis/data/7001<br>vi /usr/<span class="hljs-built_in">local</span>/redis/conf/redis_7001.conf <span class="hljs-comment"># 配置文件和上述一样，只是端口不同</span><br></code></pre></td></tr></table></figure><h3 id="制作启动文件"><a href="#制作启动文件" class="headerlink" title="制作启动文件"></a>制作启动文件</h3><p>启动脚本</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">vi cluster_start.sh<br>./redis-server ../conf/redis_7000.conf<br>./redis-server ../conf/redis_7001.conf<br>chmod +x cluster_start.sh<br></code></pre></td></tr></table></figure><p>关闭脚本</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">vi cluster_shutdown.sh<br>pgrep redis-server | xargs -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">kill</span> -9<br>chmod +x cluster_shutdown.sh<br></code></pre></td></tr></table></figure><h3 id="创建集群"><a href="#创建集群" class="headerlink" title="创建集群"></a>创建集群</h3><p>建立集群前需先启动各个节点的redis服务，并在其中一个redis服务器中执行以下指令建立集群。在5.0之后，可以直接使用redis-cli直接创建集群。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">redis-cli --cluster create 192.168.146.199:7000 192.168.146.200:7000 192.168.146.201:7000 192.168.146.199:7001 192.168.146.200:7001 192.168.146.201:7001 --cluster-replicas 1<br></code></pre></td></tr></table></figure><p>–cluster-replicas 1 参数表示希望每个主服务器都有一个从服务器，这里则代表3主3从，前3个代表3个master，后3个代表3个slave。</p><p>通过该方式创建的带有从节点的机器不能够自己手动指定主节点，redis集群会尽量把主从服务器分配在不同机器上。</p><h3 id="查看集群状态"><a href="#查看集群状态" class="headerlink" title="查看集群状态"></a>查看集群状态</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">redis-cli -c -h 192.168.146.199 -p 7000 cluster info<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>linux</tag>
      
      <tag>redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>centos7安装nginx</title>
    <link href="/2022/01/29/centos7%E5%AE%89%E8%A3%85nginx/"/>
    <url>/2022/01/29/centos7%E5%AE%89%E8%A3%85nginx/</url>
    
    <content type="html"><![CDATA[<h3 id="Centos7安装nginx"><a href="#Centos7安装nginx" class="headerlink" title="Centos7安装nginx"></a>Centos7安装nginx</h3><h4 id="安装依赖包"><a href="#安装依赖包" class="headerlink" title="安装依赖包"></a>安装依赖包</h4><figure class="highlight sh"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><pre><code class="hljs sh">yum install -y gcc automake autoconf libtool make<br>yum install -y gcc-c++<br>yum install -y pcre pcre-devel<br>yum install -y zlib zlib-devel<br>yum install -y openssl openssl-devel<br></code></pre></td></tr></table></figure><h4 id="下载nginx安装包"><a href="#下载nginx安装包" class="headerlink" title="下载nginx安装包"></a>下载nginx安装包</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">wget http://nginx.org/download/nginx-1.20.1.tar.gz<br></code></pre></td></tr></table></figure><h4 id="安装nginx"><a href="#安装nginx" class="headerlink" title="安装nginx"></a>安装nginx</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">tar -zxvf  nginx-1.20.1.tar.gz<br><span class="hljs-built_in">cd</span> nginx-1.20.1<br>./configure<br>make &amp;&amp; make install<br></code></pre></td></tr></table></figure><h4 id="启动nginx"><a href="#启动nginx" class="headerlink" title="启动nginx"></a>启动nginx</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 切换到nginx默认安装目录</span><br><span class="hljs-built_in">cd</span> /usr/<span class="hljs-built_in">local</span>/nginx/sbin<br><span class="hljs-comment"># 启动</span><br>./nginx<br><span class="hljs-comment"># 查看nginx启动情况</span><br>netstat -nlp|grep 80<br></code></pre></td></tr></table></figure><h4 id="配置及开机自启动"><a href="#配置及开机自启动" class="headerlink" title="配置及开机自启动"></a>配置及开机自启动</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 配置nginx命令</span><br>ln -s /usr/<span class="hljs-built_in">local</span>/nginx/sbin/nginx /usr/<span class="hljs-built_in">local</span>/bin/nginx<br><span class="hljs-comment"># 开机自启</span><br>systemctl status rc-local <span class="hljs-comment"># 查看自启文件，centos一般默认为 /etc/rc.d/rc.local</span><br>vi /etc/rc.d/rc.local<br><span class="hljs-comment"># 在最后一行添加nginx启动</span><br>/usr/<span class="hljs-built_in">local</span>/nginx/sbin/nginx<br><span class="hljs-comment"># 赋予可执行权限</span><br>chmod +x /etc/rc.d/ec.local<br><span class="hljs-comment"># 重新加载，需要先停止nginx服务，否付会出现端口已经占用的错误</span><br>systemctl reload rc-local<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>nginx</category>
      
    </categories>
    
    
    <tags>
      
      <tag>linux</tag>
      
      <tag>nginx</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>更新kubeadm证书</title>
    <link href="/2022/01/29/%E6%9B%B4%E6%96%B0kubeadm%E8%AF%81%E4%B9%A6/"/>
    <url>/2022/01/29/%E6%9B%B4%E6%96%B0kubeadm%E8%AF%81%E4%B9%A6/</url>
    
    <content type="html"><![CDATA[<h3 id="1-续期k8s证书"><a href="#1-续期k8s证书" class="headerlink" title="1. 续期k8s证书"></a>1. 续期k8s证书</h3><p>使用kubeadm搭建的k8s集群默认的kubectl只有一年有效期。</p><h4 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h4><ol><li>备份当前k8s证书<figure class="highlight shell"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs shell">cp -r /etc/kubernetes /etc/kubernetes.bak<br></code></pre></td></tr></table></figure></li><li>查看过期时间<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubeadm alpha certs check-expiration<br></code></pre></td></tr></table></figure></li><li>更新证书<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubeadm alpha certs renew all<br><br>systemctl restart kubelet<br><br>cp -a /etc/kubernetes/admin.conf /root/.kube/config<br></code></pre></td></tr></table></figure></li></ol><h3 id="2-需要更改文件"><a href="#2-需要更改文件" class="headerlink" title="2. 需要更改文件"></a>2. 需要更改文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs txt">└─etc<br>    └─kubernetes<br>        │  admin.conf<br>        │  config<br>        │  controller-manager.conf<br>        │  scheduler.conf<br>        │  <br>        ├─etcd<br>        │   healthcheck-client.crt<br>        │   healthcheck-client.key<br>        │   peer.crt<br>        │   peer.key<br>        │   server.crt<br>        │   server.key<br>        │      <br>        └─pki<br>            apiserver-etcd-client.crt<br>            apiserver-etcd-client.key<br>            apiserver-kubelet-client.crt<br>            apiserver-kubelet-client.key<br>            apiserver.crt<br>            apiserver.key<br>            front-proxy-client.crt<br>            front-proxy-client.key<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>kubernetes</category>
      
    </categories>
    
    
    <tags>
      
      <tag>kubernetes</tag>
      
      <tag>kubeadm</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
